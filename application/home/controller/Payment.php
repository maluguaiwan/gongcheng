<?phpnamespace app\home\controller;use app\common\controller\IndexBase;use think\Db;class Payment extends IndexBase {    public $payment; //  具体的支付类    public $pay_code; //  具体的支付code    /**     * 析构流函数     */    public function  __construct() {        parent::__construct();        // 订单支付提交        $pay_radio = $_REQUEST['pay_radio'];        if (empty($pay_radio)){            $pay_radio=$this->request->param('pay_code');        }        if (empty($pay_radio)){            $pay_radio='weixin';        }        //$pay_radio = 'weixin';        $this->pay_code=$pay_radio;        //获取通知的数据//        $xml = $GLOBALS['HTTP_RAW_POST_DATA'];        // 导入具体的支付类文件        include_once  "static/plug/payment/".$this->pay_code."/".$this->pay_code.".class.php"; // D:\wamp\www\svn_\www\plugins\payment\alipay\alipayPayment.class.php        //$code = '\\'.$this->pay_code; // \alipay        //$this->payment = new \weixin();        $code = '\\'.$this->pay_code; // \alipay        $this->payment = new $code();        //var_dump($code);exit;    }    /**     * 提交支付方式     */    public function getCode(){        header("Content-type:text/html;charset=utf-8");        $pay_name_arr=array(            'weixin'=>'微信',            'alipay'=>'支付宝',            'alipayMobile'=>'手机支付宝'        );//        $order_id = $this->makeOrder($this->request->param('type')); // 订单id        // 修改订单的支付方式//        $where_order['order_id']=['eq',$order_id];        //$data_order['pay_code']=$this->pay_code;        //$data_order['pay_name']=$pay_name_arr[$this->pay_code];        //Db::name('order')->where($where_order)->update($data_order);//        $order = Db::name('order')->where('order_id',$order_id)->find();//        if($order['pay_status'] == 1){////            $this->error('此订单，已完成支付!',url('home/index/index'));////        }        // 订单支付提交        $config_value = input('pay_radio'); // 类似于 pay_code=alipay&bank_code=CCB-DEBIT 参数        $code_str = $this->payment->get_code(array(),$config_value);        //微信JS支付        //var_dump($this->pay_code);        //var_dump(session(''));        //var_dump(session('openid'));        //var_dump(strstr($_SERVER['HTTP_USER_AGENT'],'MicroMessenger'));exit;        if($this->pay_code == 'weixin' && session('openid') && strstr($_SERVER['HTTP_USER_AGENT'],'MicroMessenger')){            $code_str = $this->payment->getJSAPI(array(),$config_value);            exit($code_str);        }        $this->assign('code_str', $code_str);        $this->assign('order_id', 1);        //$this->display('payment');  // 分跳转 和不 跳转        return $this->siteFetch('payment');    }    //生成订单    public function makeOrder($type=1){        $goods_info=get_goods_info();        if ($type==1){//上香            $data=array(                'album_id'=>$this->request->param('album_id'),                'order_sn'=>date('YmdHis',time()).rand(100000,999999),                'user_id'=>session('user_id'),                'total_amount'=>$goods_info['sx_price'],                'pay_name'=>'微信',                'number'=>0,                'price'=>$goods_info['sx_price'],                'add_time'=>time(),                'pay_time'=>time(),                'type'=>1,                'pay_ip'=>get_client_ip()            );        }else{//购买相册            $data=array(                'album_id'=>$this->request->param('album_id'),                'order_sn'=>date('YmdHis',time()).rand(100000,999999),                'user_id'=>session('user_id'),                'total_amount'=>$goods_info['xc_price']*$goods_info['xc_num'],                'pay_name'=>'微信',                'number'=>$goods_info['xc_num'],                'price'=>$goods_info['xc_price'],                'add_time'=>time(),                'pay_time'=>time(),                'type'=>2,                'pay_ip'=>get_client_ip()            );        }        $order_id=Db::name('order')->insertGetId($data);        return $order_id;    }    public function get_pay(){        header("Content-type:text/html;charset=utf-8");        $order_id=input('id');        //通过订单流水号，取得订单号和金额        $datalist=Db::name('order')->where("order_id",$order_id)->find();        $config_value=array();        //$order['order_amount'] = 1;//        $code_str = $this->payment->get_code($datalist,$config_value);////        if ($code_str['status']=='2'){////            $this->error($code_str['msg']);////        }        //微信JS支付        if($this->pay_code == 'weixin' && session('openid') && strstr($_SERVER['HTTP_USER_AGENT'],'MicroMessenger')){            $code_str = $this->payment->getJSAPI($datalist,$config_value);            var_dump($code_str);exit;            exit($code_str);        }//        $this->assign('code_str', $code_str);        $this->assign('order_id', $order_id);        //$this->display('recharge'); //分跳转 和不 跳转        return $this->display('../User/recharge');    }    // 服务器点对点 // http://www.xxx.cn/index.php/Home/Payment/notifyUrl    public function notifyUrl(){        $this->payment->response();        exit();    }    // 页面跳转 // http://www.tp-shop.cn/index.php/Home/Payment/returnUrl    public function returnUrl(){        $result = $this->payment->respond2(); // $result['order_sn'] = '201512241425288593';        $order= Db::name('order')->where('order_sn',$result['order_sn'])->find();        //$this->assign('order', $order);        if($result['status'] == 1){            update_pay_status($result['order_sn']);            return $this->success('支付成功','home/order/index');            //return $this->display('success');        }else{            return $this->error('支付失败','home/order/index');        }            //return $this->display('error');        //return $this->redirect('home/order/index');    }    //测试    public function test(){        return $this->fetch();    }}